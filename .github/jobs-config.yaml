# Cloud Run Jobs Configuration
# Centralized configuration for all ETL jobs with labels for organization
# Naming convention: etl-api-bigquery-{feature}-{type}-{name}

project_id: "sync-nhanhvn-project"
default_region: "asia-southeast1"
default_service_account: "${PROJECT_ID}@appspot.gserviceaccount.com"
default_image: "gcr.io/${PROJECT_ID}/nhanh-etl"

jobs:
  # ============================================
  # NHANH BILLS FEATURE
  # ============================================
  - name: "etl-api-bigquery-nhanh-bills-daily-sync"
    feature: "nhanh-bills"
    type: "sync"
    description: "Daily sync bills from Nhanh API → GCS → Load directly to fact tables (flattened in Python)"
    region: "asia-southeast1"
    command: "python"
    args: "src/features/nhanh/bills/daily_sync.py"
    resources:
      memory: "2Gi"
      cpu: "2"
    config:
      max_retries: 2
      task_timeout: 3600  # 1 hour
    env_vars:
      GCP_PROJECT: "${PROJECT_ID}"
      GCP_REGION: "asia-southeast1"
      BRONZE_BUCKET: "${PROJECT_ID}"
      BRONZE_DATASET: "bronze"
      TARGET_DATASET: "nhanhVN"
      LOG_LEVEL: "INFO"
    secrets:
      NHANH_APP_ID: "nhanh-app-id:latest"
      NHANH_BUSINESS_ID: "nhanh-business-id:latest"
      NHANH_ACCESS_TOKEN: "nhanh-access-token:latest"
    schedule:
      cron: "0 1 * * *"  # Daily at 1:00 AM VN time
      timezone: "Asia/Ho_Chi_Minh"
    labels:
      project: "etl-api-bigquery"
      feature: "nhanh-bills"
      type: "sync"
      environment: "production"
      layer: "bronze-to-fact"
    old_name: "nhanh-bills-daily-sync"  # For migration reference

  # ============================================
  # ONEOFFICE FEATURE
  # ============================================
  - name: "etl-api-bigquery-oneoffice-daily-sync"
    feature: "oneoffice"
    type: "sync"
    description: "Daily sync personnel data from 1Office API → BigQuery snapshot"
    region: "asia-southeast1"
    command: "python"
    args: "src/features/one_office/daily_sync.py"
    resources:
      memory: "2Gi"
      cpu: "2"
    config:
      max_retries: 2
      task_timeout: 1800  # 30 minutes
    env_vars:
      GCP_PROJECT: "${PROJECT_ID}"
      GCP_REGION: "asia-southeast1"
      BRONZE_DATASET: "bronze"
      ONEOFFICE_BASE_URL: "https://minham.1office.vn/api"
      LOG_LEVEL: "INFO"
    secrets:
      ONEOFFICE_ACCESS_TOKEN: "oneoffice-access-token:latest"
    schedule:
      cron: "0 1 * * *"  # Daily at 1:00 AM VN time
      timezone: "Asia/Ho_Chi_Minh"
    labels:
      project: "etl-api-bigquery"
      feature: "oneoffice"
      type: "sync"
      environment: "production"
      layer: "api-to-bronze"
    old_name: "oneoffice-daily-sync-job"  # For migration reference

  # ============================================
  # WEBVIEW MESSCARD FEATURE
  # ============================================
  - name: "webview-messenger-reader-messcard-daily"
    feature: "webview-messcard"
    type: "notify"
    description: "Trigger webview messenger service to send store-based messcard and matrix report"
    region: "asia-southeast1"
    command: "python"
    args: "src/scripts/send_messcard.py"
    resources:
      memory: "1Gi"
      cpu: "1"
    config:
      max_retries: 2
      task_timeout: 900  # 15 minutes
    env_vars:
      GCP_PROJECT: "${PROJECT_ID}"
      GCP_REGION: "asia-southeast1"
      MESSCARD_BASE_URL: "https://webview-messenger-reader-858039461446.asia-southeast1.run.app"
      LOG_LEVEL: "INFO"
    labels:
      project: "etl-api-bigquery"
      feature: "webview-messcard"
      type: "notify"
      environment: "production"
      layer: "app-trigger"
    schedule:
      cron: "5 16 * * *"  # Daily at 16:05 VN time (UTC+7)
      timezone: "Asia/Ho_Chi_Minh"
      name: "webview-messenger-reader-messcard-schedule"


